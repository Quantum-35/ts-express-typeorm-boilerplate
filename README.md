# 3rd party Typescript boilerplate

[![Build Status](https://travis-ci.com/konfer-be/ts-express-typeorm-boilerplate.svg?token=DmbPFqq91BhwsJKVDsHw&branch=master)](https://travis-ci.com/konfer-be/ts-express-typeorm-boilerplate)
[![Coverage](https://img.shields.io/badge/Coverage-86.49%25-green)](https://github.com/ellerbrock/typescript-badges/)
[![Node](https://img.shields.io/badge/Node-10.9-green)](https://nodejs.org/docs/latest-v10.x/api/index.html)
[![Express](https://img.shields.io/badge/Express-4.16-lightgrey)](https://expressjs.com/fr/)
[![TypeScript](https://img.shields.io/badge/Typescript-5.3-blue)](https://www.typescriptlang.org/)
[![Typeorm](https://img.shields.io/badge/Typeorm-0.2-orange)](https://typeorm.io/#/)
[![MIT Licence](https://badges.frapsoft.com/os/mit/mit.svg?v=103)](https://opensource.org/licenses/mit-license.php)

This repository contains API part about mail sending, [REST API Typescript-Express-Typeorm](https://github.com/konfer-be/rest-api-ts-express-typeorm) based.

## Setup

This repository contains badass 3rd party REST API boilerplate [Express.js](http://expressjs.com/en/4x/api.html), [Typescript](https://github.com/Microsoft/TypeScript) and [TypeORM](https://github.com/typeorm/typeorm) based.

As a starter project, he implements some classic features :

* ORM couch
* User's management
* Document's management
* Authentification
* Routes validation
* File upload
* Logger
* Error handling
* Files generating
* Testing

## End points

See boilerplate API documentation at : https://www.cliam.email/docs/apidoc

## Start with

Clone the boilerplate on your machine :

```bash
$ git clone https://github.com/konfer-be/rest-api-ts-express-typeorm.git your-project-name/
```

Remove .git directory :

```bash
$ cd your-project-name/
$ rm -rf .git
```

Kickstart project (create *dist* directory and sub-directories, install packages, install typescript and typeorm globaly, and run a first compilation) :

```bash
$ npm run kickstart
```

Adapt yours .env files (dev, test, staging, production) with your own configuration :

```env
# Environment
NODE_ENV = "development"

# API version
API_VERSION = "v1"

# Application port
PORT = 8001

# Application URL
URL = "http://your-development-url.com"

# CORS authorized domains, by coma separated WITHOUT spacing
AUTHORIZED = "http://localhost:8001"

# HTTPS configuration 
HTTPS_IS_ACTIVE = 0
HTTPS_CERT = "my-api.cert"
HTTPS_KEY = "my-api.key"

# JWT Secret passphrase
JWT_SECRET = "your-passphrase"

# JWT Expiration
JWT_EXPIRATION_MINUTES = 15

# TypeORM
TYPEORM_TYPE = "mysql"
TYPEORM_NAME = "default"
TYPEORM_HOST = "localhost"
TYPEORM_DB = "your-database-name"
TYPEORM_USER = "root"
TYPEORM_PWD = "root"
TYPEORM_PORT = "3306"
TYPEORM_SYNC = 0
TYPEORM_LOG = 0

# Jimp
JIMP_IS_ACTIVE = 1
JIMP_SIZE_XS = 320
JIMP_SIZE_MD = 768
JIMP_SIZE_XL = 1920

# API mail credentials
MAIL_API_ID = 'PIvyWM9y2hFR0cie'
MAIL_API_ROUTE = 'http://api.mail.triptyk.eu/api/1.0/'
```
Enjoy with :

```bash
$ nodemon
```

## Typescript Compilation

The production project is generated by default in the *dist* directory, after Typescript compilation.

Run one time compilation :

```bash
$ tsc
```

Run watching compilation :

```bash
$ tsc --watch
```

If required, yo can adapt typescript configuration in [tsconfig.json](https://www.typescriptlang.org/docs/handbook/tsconfig-json.html) :

```javascript
{
  "compilerOptions": {
    "lib": ["dom", "es5", "es6"],
    "target": "es2017",
    "module": "commonjs",
    "allowSyntheticDefaultImports": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "sourceMap": false,
    "outDir": "./dist/"
  },
  "exclude" : [
    "**/**/node_modules",
    "node_modules"
  ]
}
```

This is recommanded to maintains the *dist* directory as output compilation target.

## TypeORM configuration

If you will use TypeORM as CLI, begin by update the ormconfig.json file and fill in with your own configuration :

```javascript
{
  "type": "mysql",
  "name": "default",
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "root",
  "database": "your-database",
  "synchronize": false,
  "logging": false,
  "entities": [
    "./dist/api/models/**/*.js"
  ],
  "migrations": [
    "./dist/migrations/**/*.js"
  ],
  "cli": {
    "migrationsDir": "./dist/migrations"
  },
  "subscribers": [
    "src/subscribers/**/*.ts"
  ]
}
```

More info about [ormconfig file](http://typeorm.io/#/using-ormconfig) and [typeorm cli](https://typeorm.io/#/using-cli/installing-cli).

### Database migration

A TypeORM migration is a DB synchronizing. If your schema have pending changes, migration tool allow you to synchronize it.

```bash
$ typeorm migration:generate -n NameOfYoursPendingChanges
$ npm run typeorm migration:run
```

More info about [typeorm migration](http://typeorm.io/#/migrations).

### Events subscribers

TypeORM provides events listening on your models. So, you can define your owns listeners/subscribers, and use it to do actions when a specific event is fired.

More info about [typeorm subscribers](https://typeorm.io/#/listeners-and-subscribers).

## Files generating

The boilerplate expose a basic files generator which be used as NPM task. This generate following files :

* Model
* Controller 
* Custom repository
* Validation 
* Route
* Test
* Serializer

So, the proxy router file (index.ts) is updated with the dedicated entity router which has just been created.

To use the file generating, run the following command :

```bash
$ npm run generate YOUR_ENTITY_NAME
```

Note that the generated files contains only basic features. Note also that some parts must be filled by hand :

* Validation rules: body rules are created but empty by default. Fill it with your rules.
* Model: model is filled with a primary auto-incremented id, and date system columns. Fill it with your columns and relations.
* Serializer: attributes as empty by default.Fill it with your entity attributes.

## Testing

Some basic tests are already writted with [Mocha](https://mochajs.org/) and [Chai](https://www.chaijs.com/). They are located in *test* directory.

[Jenkins](https://jenkins.io/) is also available in the project, but not used from scratch. 

To run your tests, launch the following command :

```bash
$ npm run test --env test
```

## Deployment with PM2

Project implements a basic [PM2](https://github.com/Unitech/PM2/) configuration to allow easy deployment.

First, install PM2 globaly :

```bash
$ npm i pm2 -g
```

Note that PM2 should also be installed on other server environments, and that your SSH public key must be granted by the destination server.

### Setup

Configure the *ecosystem.config.js* file with your environments informations.

```javascript
deploy : {
  staging : {
    path : 'path-to-your-SSH-public-key',
    user : 'node',
    host : '212.83.163.1',
    ref  : 'origin/master',
    repo : 'git@github.com:repo.git',
    path : '/var/www/staging',
    'post-deploy' : 'npm install && pm2 reload ecosystem.config.js --env staging'
  },
  production : {
    path : 'path-to-your-SSH-public-key',
    user : 'node',
    host : '212.83.163.1',
    ref  : 'origin/master',
    repo : 'git@github.com:repo.git',
    path : '/var/www/production',
    'post-deploy' : 'npm install && pm2 reload ecosystem.config.js --env production'
  }
}
```
More info about PM2 [ecosystem.config.js](https://pm2.io/doc/en/runtime/reference/ecosystem-file/) file.

### Deploy

```bash
# Setup deployment at remote location
$ pm2 deploy production setup

# Update remote version
$ pm2 deploy production update

# Revert to -1 deployment
$ pm2 deploy production revert 1

# execute a command on remote servers
$ pm2 deploy production exec "pm2 reload all"
```

More info about [PM2 deploy](https://pm2.io/doc/en/runtime/guide/easy-deploy-with-ssh/).

More info about [PM2](http://pm2.keymetrics.io/docs/usage/quick-start/).

## Dependencies

- awilix (dependency injection)
- axios (http requests)
- bcrypt (cryptography)
- body-parser (payload exposition)
- boom (errors throwing)
- compression (gzip responses)
- cookie-parser (cookie exposition)
- cors (security)
- crypto (cryptography) | cryptr (cryptography)
- dotenv (.env files)
- errorhandler (errors handling)
- es6-promisify (es6 promisification)
- express (framework)
- express-hbs (template compilation)
- express-rate-limit (rate limit on api)
- express-validation (validation)
- express-validator (on the fly validation)
- helmet (security)
- hpp (security)
- http-status (easy HTTP status response)
- jimp (image manipulation)
- joi (validation rules)
- json-api-serializer (serializing)
- jwt-simple (JWT enconding / decoding)
- lodash (utils)
- module-alias (typescript paths)
- moment (date treatments)
- moment-timezone (date treatments)
- morgan (HTTP logs)
- multer (file upload)
- node-mailjet (mailjet api)
- node-mailchimp (mailchimp api)
- nodemailer (email sending)
- nodemailer-mailgun-transport (email transport)
- nodemailer-mandrill-transport (email transport)
- nodemailer-sendgrid (email transport)
- nodemailer-sendinblue-transport (email transport)
- nodemailer-sparkpost-transport (email transport)
- node-notifier (desktop notifications)
- passport (authentification)
- passport-facebook (authentification with Facebook graph)
? passport-google-auth (authentification with Google oAuth)
- passport-http-bearer (authentification with Bearer strategy)
- passport-jwt (authentification with JWT)
- passport-local (authentification with local database)
- pluralize (pluralization)
- reflect-metadata (model reflection)
- request (http requests)
- typeorm (ORM)
- uuid (unique identifier generating)
- winston (logs)